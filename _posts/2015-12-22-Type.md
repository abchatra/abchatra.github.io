---
layout: post
title: Type
---

###Introduction
Javascript is an untyped language. [Type](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/Type.h#L22) in the context of this blog refers to a data structure in the Chakra runtime which holds additional information about an object. Type is also popularly known as hidden class. The sole purpose of a type in the runtime is to enhance the performance of the user script code. If you are building your own javascript runtime and didn't care about performance or the memory you don't need type. 

Chakra has two kinds of type, static type and dynamic type. The [static type](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/StaticType.h) is for the primitive object which can't store properties in it. For example: String ("hello"), Boolean (true or false), Number (10.4) etc. The [Dynamic object] (https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/DynamicObject.h#L46)  which can store properties have [dynamic type](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/DynamicType.h). Example: `{} or new Point()`. Let us go bit deeper into static type and dynamic type and see how they share the data. 


###Static Type
Every [RecyclableObject](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/RecyclableObject.h#L191) holds a pointer to a type. Every object class in Chakra inherits from RecyclableObject except [tagged floats](http://abchatra.github.io/TaggedFloat/). Lets take an example:

```js
var greeting = "hello";
var message = "open source";
```

Here we have two literal strings `greeting` and `message` which Chakra tracks as a [JavascriptString](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Library/JavascriptString.h#L50). JavascriptString class inherits from RecyclableObject. Both `greeting` and `message` points to a shared type. 

![Object Layout]({{ site.baseurl }}/images/2015-12-22-Type-StaticTypesharing.png)

The type has a [TypeId](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/EdgeJavascriptTypeId.h#L23) field which is set to TypeIds_String in this example and shared between two literal strings. It may seem overkill to share an integer TypeId when you have to add a pointer to that type in the literal string objects. In reality, type contains a lot of additional data, not just the type id. Following is the field dump of the type. Prototype and entrypoint are the other important information about the which are shared as well.

```C++
Js::Type
    typeId    TypeIds_String (7)    Js::TypeId
    flags        
    javascriptLibrary*
    prototype*
    entryPoint*
    propertyCache*
```

JavscriptString type is a static type. Dynamic objects provide a lot more opportunity to share information. Again dynamic objects have a dynamic type.

###Dynamic Type
Let us take an example first:

```js
function Point(x, y)
{ 
  this.x = x;
  this.y = y;
}
var one = new Point(10,20);
var two = new Point(40,50);

print(one.x);
print(two.x);
```

Above script creates two *Point* objects which have properties x and y. Chakra needs to store following information in the runtime:

1.  Objects one and two have properties x and y
2.  Object one has property x whose value is 10 and property y whose value is 20
3.  Object two has property x whose value is 40 and property y whose value is 50

Above information needs to be retrieved when the script wants to get or set the property. Note (1) is shareable among multiple objects. (2) & (3) are specific to individual dynamic objects. A typical way to store this information is in a form of a property map and a slot array.

- Property map, maps between property and slot number. Example: Property x is present at slot 0. 
- Slot array stores the values. Example slots[0] contains the value of property x. 

Property map is stored in a [dynamic type](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/DynamicType.h). When script does *one.x*, Chakra fetches property map in the *one->type* to figure out the slot number corresponding to x which is 0 here. Then it fetches *one->slots[0]* to get the value 10. 

The following diagram illustrates the same. 

![Object Layout]({{ site.baseurl }}/images/2015-12-22-Type-ObjectLayout-sharing.png)

The same type can be shared by all the objects created from constructor *Point*. Even if you create a million *Points*, you just need a type to represent them all. Memory saving is just tip of the iceberg of all the optimizations which can be possible by the type. I will note couple more here:

- Inline Cache
- Object type specialization in JIT
- Function specialization

Going deeper into these optimizations necessitates a separate post. First we need understand how this type hierarchy is built. [Typehanlder](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/DynamicType.h#L28) which is part of a dynamic type handles how the property map is stored and how a brand vanilla dynamic object gets its type. 

###Typehandler

Typehandler in a dynamic type serves two important goals:

1. Maintains a property map which maps between a property and a slot number. 
2. Maintain successor types. 

We have already seen property map is to share information between objects. But what is successor type? 
Let us go back to an example: 

```js
var one = {};       
var two = {};       
//Objects one and two point to Type1

doSomething1(one);
one.x = 10;     
//Object one points to Type2 and object two points to Type1

doSomething2(one);
one.y = 20;     
//Object one points to Type3 and object two points to Type1

two.x = 10;     
//Object one points to Type3 and object two points to Type2
doSomething3(one, two);

two.y = 20;     
//Object one and two point to Type3
```
Assumtion here is doSomething* doesn't mutate objects, it just access properties off them. Looking at the above example its obvious that its optimal that object one and two point to the exact same type in the begining and at the end of the script. Eventhough it can point to different type sa 

![Object Layout]({{ site.baseurl }}/images/2015-12-22-Type-ObjectLayout-TypePath.png)


For the simplicity let us take a look at  [SimpleTypeHandler](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/PathTypeHandler.h#L207). SimpleTypeHanlder has a property map named [typePath](https://github.com/Microsoft/ChakraCore/blob/master/lib/Runtime/Types/PathTypeHandler.h#L15) which has a tiny dictionary to map between propertyId (synonymous to property name) to slot number. It also consists of PropertySuccessorsMap which maps between

###Summary
